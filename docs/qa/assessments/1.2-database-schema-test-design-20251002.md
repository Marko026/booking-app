# Test Design: Story 1.2 - Database Schema & Prisma Setup

Date: 2025-10-02
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 18 (43%)
- **Integration tests**: 22 (52%)
- **E2E tests**: 2 (5%)
- **Priority distribution**: P0: 14, P1: 20, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: Prisma installed and configured with SQLite for development

#### Scenarios

| ID           | Level       | Priority | Test                                     | Justification                            | Mitigates Risk |
| ------------ | ----------- | -------- | ---------------------------------------- | ---------------------------------------- | -------------- |
| 1.2-INT-001  | Integration | P0       | Prisma initializes with SQLite provider  | Validates core infrastructure setup      | TECH-001       |
| 1.2-INT-002  | Integration | P1       | DATABASE_URL environment variable loaded | Validates configuration management       | OPS-001        |
| 1.2-UNIT-001 | Unit        | P2       | .env.example contains correct template   | Validates developer onboarding materials | -              |

**Coverage**: 3 scenarios covering installation validation, configuration, and documentation

---

### AC2: Apartment schema defined with all required fields

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                       | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ----------------------------------- | -------------- |
| 1.2-INT-003  | Integration | P0       | Apartment model exists in Prisma Client | Validates schema generation         | -              |
| 1.2-UNIT-002 | Unit        | P0       | Apartment has all required fields       | Validates schema completeness       | -              |
| 1.2-UNIT-003 | Unit        | P0       | basePricePerNight uses Decimal with @db | Validates currency precision        | DATA-002       |
| 1.2-INT-004  | Integration | P1       | Can create Apartment with all fields    | Validates database schema execution | -              |
| 1.2-UNIT-004 | Unit        | P1       | ApartmentStatus enum has all values     | Validates enum definition           | -              |
| 1.2-UNIT-005 | Unit        | P2       | Apartment timestamps auto-populate      | Validates Prisma default behavior   | -              |

**Coverage**: 6 scenarios covering schema definition, field types, and data creation

---

### AC3: Guest schema defined with required fields

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                        | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------ | ------------------------------------ | -------------- |
| 1.2-INT-005  | Integration | P0       | Guest model exists in Prisma Client  | Validates schema generation          | -              |
| 1.2-UNIT-006 | Unit        | P0       | Guest has all required fields        | Validates schema completeness        | -              |
| 1.2-UNIT-007 | Unit        | P0       | Guest.email has unique constraint    | Validates data integrity constraint  | SEC-001        |
| 1.2-INT-006  | Integration | P0       | Cannot create duplicate guest emails | Validates unique constraint enforced | SEC-001        |
| 1.2-INT-007  | Integration | P1       | Can create Guest with all fields     | Validates database schema execution  | -              |

**Coverage**: 5 scenarios covering schema definition, uniqueness constraints, and data creation

---

### AC4: Booking schema defined with all required fields

#### Scenarios

| ID           | Level       | Priority | Test                                       | Justification                       | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------------ | ----------------------------------- | -------------- |
| 1.2-INT-008  | Integration | P0       | Booking model exists in Prisma Client      | Validates schema generation         | -              |
| 1.2-UNIT-008 | Unit        | P0       | Booking has all required fields            | Validates schema completeness       | -              |
| 1.2-UNIT-009 | Unit        | P0       | totalPrice uses Decimal with precision     | Validates currency precision        | DATA-002       |
| 1.2-UNIT-010 | Unit        | P0       | BookingStatus enum has all values          | Validates enum definition           | -              |
| 1.2-UNIT-011 | Unit        | P1       | confirmationCode is unique                 | Validates unique constraint         | -              |
| 1.2-INT-009  | Integration | P1       | Can create Booking with all required data  | Validates database schema execution | -              |
| 1.2-INT-010  | Integration | P1       | Date fields stored as date-only (@db.Date) | Validates date handling             | TECH-001       |

**Coverage**: 7 scenarios covering schema definition, field types, constraints, and date handling

---

### AC5: PricingRule schema defined with required fields

#### Scenarios

| ID           | Level       | Priority | Test                                        | Justification                       | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------------- | ----------------------------------- | -------------- |
| 1.2-INT-011  | Integration | P0       | PricingRule model exists in Prisma Client   | Validates schema generation         | -              |
| 1.2-UNIT-012 | Unit        | P0       | PricingRule has all required fields         | Validates schema completeness       | -              |
| 1.2-UNIT-013 | Unit        | P0       | pricePerNight uses Decimal with precision   | Validates currency precision        | DATA-002       |
| 1.2-INT-012  | Integration | P1       | Can create PricingRule with optional fields | Validates database schema execution | -              |
| 1.2-INT-013  | Integration | P1       | PricingRule date range validates correctly  | Validates date handling             | DATA-003       |

**Coverage**: 5 scenarios covering schema definition, field types, and date validation

---

### AC6: Foreign key relationships established

#### Scenarios

| ID          | Level       | Priority | Test                                          | Justification                     | Mitigates Risk |
| ----------- | ----------- | -------- | --------------------------------------------- | --------------------------------- | -------------- |
| 1.2-INT-014 | Integration | P0       | Booking → Apartment relationship exists       | Validates critical foreign key    | -              |
| 1.2-INT-015 | Integration | P0       | Booking → Guest relationship exists           | Validates critical foreign key    | -              |
| 1.2-INT-016 | Integration | P0       | PricingRule → Apartment relationship exists   | Validates critical foreign key    | -              |
| 1.2-INT-017 | Integration | P0       | Deleting Apartment cascades to Bookings       | Validates cascade behavior        | DATA-003       |
| 1.2-INT-018 | Integration | P1       | Can query bookings through apartment relation | Validates relation traversal      | -              |
| 1.2-INT-019 | Integration | P1       | Can query apartment through booking relation  | Validates bidirectional relations | -              |
| 1.2-INT-020 | Integration | P2       | Deleting Guest cascades to Bookings           | Validates cascade behavior        | DATA-003       |

**Coverage**: 7 scenarios covering all relationships, cascade behavior, and relation queries

---

### AC7: Database indexes created on critical fields

#### Scenarios

| ID           | Level       | Priority | Test                                           | Justification                      | Mitigates Risk |
| ------------ | ----------- | -------- | ---------------------------------------------- | ---------------------------------- | -------------- |
| 1.2-UNIT-014 | Unit        | P0       | Booking has composite index on apartment+dates | Validates performance optimization | PERF-001       |
| 1.2-UNIT-015 | Unit        | P0       | Booking has index on confirmationCode          | Validates lookup optimization      | PERF-001       |
| 1.2-UNIT-016 | Unit        | P0       | Booking has index on status                    | Validates filter optimization      | PERF-001       |
| 1.2-UNIT-017 | Unit        | P1       | Guest has index on email                       | Validates lookup optimization      | PERF-001       |
| 1.2-UNIT-018 | Unit        | P1       | PricingRule has composite index                | Validates query optimization       | PERF-001       |
| 1.2-INT-021  | Integration | P1       | Query by confirmationCode uses index (EXPLAIN) | Validates index usage              | PERF-001       |

**Coverage**: 6 scenarios covering index definition and query optimization

---

### AC8: Prisma Client generated with TypeScript types

#### Scenarios

| ID          | Level       | Priority | Test                                    | Justification                     | Mitigates Risk |
| ----------- | ----------- | -------- | --------------------------------------- | --------------------------------- | -------------- |
| 1.2-INT-022 | Integration | P0       | Prisma Client exports all models        | Validates generation completeness | -              |
| 1.2-E2E-001 | E2E         | P0       | Can import and use Prisma Client in app | Validates end-to-end integration  | -              |
| 1.2-E2E-002 | E2E         | P1       | TypeScript types available from client  | Validates type safety             | -              |

**Coverage**: 3 scenarios covering client generation and TypeScript integration

---

### AC9: Seed script created with sample apartments

#### Scenarios

| ID          | Level       | Priority | Test                                       | Justification                | Mitigates Risk |
| ----------- | ----------- | -------- | ------------------------------------------ | ---------------------------- | -------------- |
| 1.2-INT-023 | Integration | P1       | Seed script creates 2 apartments           | Validates seed data creation | -              |
| 1.2-INT-024 | Integration | P1       | Seed script is idempotent (upsert logic)   | Validates safe re-run        | TECH-002       |
| 1.2-INT-025 | Integration | P1       | Seeded apartments have all required data   | Validates data completeness  | -              |
| 1.2-INT-026 | Integration | P2       | Seeded apartments have valid photo URLs    | Validates data quality       | -              |
| 1.2-INT-027 | Integration | P2       | Seeded apartments have realistic amenities | Validates JSON field usage   | TECH-001       |

**Coverage**: 5 scenarios covering seed script functionality and data quality

---

### AC10: Migration created and applied successfully

#### Scenarios

| ID          | Level       | Priority | Test                                         | Justification                  | Mitigates Risk |
| ----------- | ----------- | -------- | -------------------------------------------- | ------------------------------ | -------------- |
| 1.2-INT-028 | Integration | P0       | Initial migration file exists                | Validates migration creation   | DATA-001       |
| 1.2-INT-029 | Integration | P0       | Migration applies successfully to clean DB   | Validates migration execution  | DATA-001       |
| 1.2-INT-030 | Integration | P0       | Migration is idempotent (can reapply safely) | Validates migration safety     | DATA-001       |
| 1.2-INT-031 | Integration | P1       | Migration rollback restores previous state   | Validates rollback capability  | DATA-001       |
| 1.2-INT-032 | Integration | P1       | dev.db file created after migration          | Validates SQLite configuration | -              |
| 1.2-INT-033 | Integration | P1       | Schema matches PostgreSQL target (prototype) | Validates production readiness | TECH-001       |

**Coverage**: 6 scenarios covering migration lifecycle and cross-database validation

---

### AC11: Database helper utilities created in lib/db.ts

#### Scenarios

| ID          | Level       | Priority | Test                                          | Justification                   | Mitigates Risk |
| ----------- | ----------- | -------- | --------------------------------------------- | ------------------------------- | -------------- |
| 1.2-INT-034 | Integration | P0       | lib/db.ts exports singleton PrismaClient      | Validates connection management | OPS-001        |
| 1.2-INT-035 | Integration | P0       | Singleton prevents multiple instances in dev  | Validates connection pooling    | OPS-001        |
| 1.2-INT-036 | Integration | P1       | lib/db.ts exports all TypeScript types        | Validates type exports          | -              |
| 1.2-INT-037 | Integration | P1       | Query logging enabled in development mode     | Validates debugging capability  | -              |
| 1.2-INT-038 | Integration | P2       | Can connect to database using exported client | Validates utility functionality | -              |

**Coverage**: 5 scenarios covering connection management and utility exports

---

## Risk Coverage Matrix

| Risk ID  | Test IDs Covering Risk                             | Coverage |
| -------- | -------------------------------------------------- | -------- |
| DATA-001 | 1.2-INT-028, 1.2-INT-029, 1.2-INT-030, 1.2-INT-031 | Complete |
| DATA-002 | 1.2-UNIT-003, 1.2-UNIT-009, 1.2-UNIT-013           | Complete |
| DATA-003 | 1.2-INT-013, 1.2-INT-017, 1.2-INT-020              | Partial  |
| TECH-001 | 1.2-INT-001, 1.2-INT-010, 1.2-INT-027, 1.2-INT-033 | Complete |
| TECH-002 | 1.2-INT-024                                        | Complete |
| PERF-001 | 1.2-UNIT-014 through 1.2-UNIT-018, 1.2-INT-021     | Complete |
| OPS-001  | 1.2-INT-002, 1.2-INT-034, 1.2-INT-035              | Complete |
| SEC-001  | 1.2-UNIT-007, 1.2-INT-006                          | Complete |

**Risk Coverage Summary**: 8/8 risks have test coverage (100%)

---

## Recommended Test Execution Order

### Phase 1: Foundation Tests (P0 Unit Tests)

Run first to validate schema definition correctness:

1. 1.2-UNIT-002, 1.2-UNIT-006, 1.2-UNIT-008, 1.2-UNIT-012 (Model completeness)
2. 1.2-UNIT-003, 1.2-UNIT-009, 1.2-UNIT-013 (Decimal precision)
3. 1.2-UNIT-007 (Unique constraints)
4. 1.2-UNIT-014, 1.2-UNIT-015, 1.2-UNIT-016 (Index definitions)

**Rationale**: Fast feedback on schema definition errors before attempting database operations

---

### Phase 2: Integration Tests (P0 Integration Tests)

Validate database operations and relationships:

1. 1.2-INT-001 (Prisma initialization)
2. 1.2-INT-003, 1.2-INT-005, 1.2-INT-008, 1.2-INT-011 (Model generation)
3. 1.2-INT-028, 1.2-INT-029, 1.2-INT-030 (Migration execution)
4. 1.2-INT-014, 1.2-INT-015, 1.2-INT-016, 1.2-INT-017 (Relationships)
5. 1.2-INT-006 (Unique constraint enforcement)
6. 1.2-INT-022, 1.2-INT-034, 1.2-INT-035 (Client & utilities)

**Rationale**: Validates schema works correctly with actual database

---

### Phase 3: E2E Tests (P0 E2E Tests)

Validate complete integration:

1. 1.2-E2E-001 (Import and use in application)
2. 1.2-E2E-002 (TypeScript integration)

**Rationale**: Confirms everything works end-to-end

---

### Phase 4: P1 Tests

Run all P1 tests to validate secondary scenarios:

- All P1 unit tests (enum values, timestamps, optional fields)
- All P1 integration tests (relation queries, seed scripts, migration rollback)

---

### Phase 5: P2 Tests (Optional)

Run P2 tests if time permits:

- Developer experience tests (.env.example, documentation)
- Data quality tests (seed data validation)
- Additional relationship tests

---

## Test Coverage Analysis

### Coverage by Acceptance Criteria

| AC   | Description               | Test Count | Unit | Int | E2E | Coverage |
| ---- | ------------------------- | ---------- | ---- | --- | --- | -------- |
| AC1  | Prisma installation       | 3          | 1    | 2   | 0   | ✓        |
| AC2  | Apartment schema          | 6          | 4    | 2   | 0   | ✓        |
| AC3  | Guest schema              | 5          | 2    | 3   | 0   | ✓        |
| AC4  | Booking schema            | 7          | 4    | 3   | 0   | ✓        |
| AC5  | PricingRule schema        | 5          | 2    | 3   | 0   | ✓        |
| AC6  | Foreign key relationships | 7          | 0    | 7   | 0   | ✓        |
| AC7  | Database indexes          | 6          | 5    | 1   | 0   | ✓        |
| AC8  | Prisma Client generation  | 3          | 0    | 1   | 2   | ✓        |
| AC9  | Seed script               | 5          | 0    | 5   | 0   | ✓        |
| AC10 | Migration execution       | 6          | 0    | 6   | 0   | ✓        |
| AC11 | Database helper utilities | 5          | 0    | 5   | 0   | ✓        |

**All 11 acceptance criteria have complete test coverage** ✓

---

## Test Implementation Notes

### Unit Test Setup

**Test Framework**: Jest with `@prisma/client` type mocking

**Example structure**:

```typescript
describe('Prisma Schema Definition', () => {
	it('1.2-UNIT-002: Apartment has all required fields', () => {
		const apartmentFields = Object.keys(Prisma.ApartmentScalarFieldEnum)
		expect(apartmentFields).toContain('id')
		expect(apartmentFields).toContain('name')
		expect(apartmentFields).toContain('description')
		expect(apartmentFields).toContain('maxGuests')
		expect(apartmentFields).toContain('basePricePerNight')
		// ... etc
	})
})
```

---

### Integration Test Setup

**Test Framework**: Jest with test database

**Database Strategy**:

- Use in-memory SQLite for fast execution: `:memory:`
- Reset database before each test suite
- Use Prisma migrations in test setup

**Example structure**:

```typescript
describe('Prisma Database Operations', () => {
	beforeAll(async () => {
		// Run migrations
		execSync('pnpm exec prisma migrate deploy')
	})

	afterAll(async () => {
		await prisma.$disconnect()
	})

	it('1.2-INT-004: Can create Apartment with all fields', async () => {
		const apartment = await prisma.apartment.create({
			data: {
				name: 'Test Apartment',
				description: 'Test description',
				maxGuests: 4,
				basePricePerNight: new Prisma.Decimal(100.0),
				photos: ['photo1.jpg'],
				amenities: { wifi: true, parking: false },
			},
		})

		expect(apartment.id).toBeDefined()
		expect(apartment.name).toBe('Test Apartment')
	})
})
```

---

### E2E Test Setup

**Test Framework**: Playwright or Cypress (for application-level integration)

**Strategy**:

- Test that database can be imported and used in Next.js API route
- Verify TypeScript types are available

**Example structure**:

```typescript
describe('Database Integration in Application', () => {
	it('1.2-E2E-001: Can import and use Prisma Client in app', async () => {
		// Test API route that uses prisma
		const response = await fetch('/api/test-db-connection')
		expect(response.ok).toBe(true)

		const data = await response.json()
		expect(data.connected).toBe(true)
	})
})
```

---

## Test Data Requirements

### Minimal Test Data

For integration tests, create minimal valid records:

```typescript
// Test apartment
const testApartment = {
	name: 'Test Studio',
	description: 'A test apartment',
	maxGuests: 2,
	basePricePerNight: new Prisma.Decimal('50.00'),
	photos: ['https://example.com/photo.jpg'],
	amenities: { wifi: true },
}

// Test guest
const testGuest = {
	firstName: 'John',
	lastName: 'Doe',
	email: `test-${Date.now()}@example.com`, // Unique email
	phone: '+1234567890',
}

// Test booking
const testBooking = {
	apartmentId: apartment.id,
	guestId: guest.id,
	startDate: new Date('2025-11-01'),
	endDate: new Date('2025-11-03'),
	numberOfGuests: 2,
	totalPrice: new Prisma.Decimal('100.00'),
	status: 'PENDING',
	confirmationCode: 'TEST1234',
}
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing with E2E)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (P0 for data integrity, migrations)
- [x] Test IDs follow naming convention ({epic}.{story}-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] All identified risks have test coverage
- [x] Migration testing included (rollback, idempotency)
- [x] Cross-database considerations tested (SQLite → PostgreSQL)

---

## Test Metrics & Success Criteria

### Definition of Done for Testing

- All P0 tests pass (14 tests)
- All P1 tests pass (20 tests)
- At least 80% of P2 tests pass (6/8 tests)
- All risk-mitigating tests pass
- Migration rollback tested successfully
- Seed script runs without errors

### Coverage Targets

- **Unit Test Coverage**: >90% for schema definitions
- **Integration Test Coverage**: 100% for all database operations
- **E2E Test Coverage**: Core import and usage validated

### Performance Benchmarks

Tests should complete within:

- Unit tests: <5 seconds total
- Integration tests: <30 seconds total
- E2E tests: <10 seconds total

---

## Next Story Integration

These tests establish the foundation for:

- **Story 1.3** (Authentication): User model testing
- **Story 2.1** (Availability Calendar): Booking query performance tests
- **Story 2.2** (Pricing Calculation): PricingRule logic integration tests
- **Story 1.6** (Deployment): PostgreSQL migration validation

---

## Key Principles Applied

✓ **Shift left**: 43% unit tests for fast feedback
✓ **Risk-based**: All high/medium risks have P0/P1 test coverage
✓ **Efficient coverage**: Each scenario tests one thing at the right level
✓ **Maintainability**: Clear test IDs and atomic scenarios
✓ **Fast feedback**: Unit tests run first, E2E tests minimal
